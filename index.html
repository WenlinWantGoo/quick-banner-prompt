<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockGen AI | Prompt 生成模式 (AI 增強版)</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Markdown Parser (marked) for safety if AI returns markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            dark: '#0f172a',
                            panel: '#1e293b',
                            accent: '#38bdf8',
                            danger: '#ef4444',
                            success: '#10b981',
                            warning: '#f59e0b'
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* Custom scrollbar for textareas */
        textarea::-webkit-scrollbar {
            width: 8px;
            background-color: #1e293b;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #475569;
            border-radius: 4px;
        }
        
        .ai-gradient-text {
            background: linear-gradient(to right, #38bdf8, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .ai-border {
            position: relative;
        }
        .ai-border::before {
            content: "";
            position: absolute;
            inset: -2px;
            border-radius: 10px;
            background: linear-gradient(45deg, #38bdf8, #818cf8, #c084fc);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .ai-border:hover::before {
            opacity: 1;
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col font-sans">
    
    <!-- Header -->
    <header class="border-b border-slate-700 bg-slate-900/80 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-wand-magic-sparkles text-brand-warning text-2xl"></i>
                <div>
                    <h1 class="text-xl font-bold tracking-wider text-white">StockGen Prompt <span class="text-xs bg-brand-warning text-slate-900 px-1 rounded ml-1">AI+</span></h1>
                    <p class="text-xs text-slate-400">AI 輔助提示詞生成器</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- API Key Toggler -->
                <div class="relative">
                    <button @click="showApiKey = !showApiKey" class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded border border-slate-600 transition-colors flex items-center gap-2">
                        <i class="fas fa-key"></i> {{ apiKey ? 'API Key 已設定' : '設定 API Key' }}
                    </button>
                    
                    <!-- Dropdown -->
                    <div v-if="showApiKey" class="absolute right-0 top-10 w-72 bg-slate-800 border border-slate-600 p-4 rounded-xl shadow-2xl z-50">
                        <label class="block text-xs font-bold text-slate-400 mb-2">Gemini API Key</label>
                        <input v-model="apiKey" type="password" placeholder="貼上您的 API Key" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-xs text-white focus:outline-none focus:border-brand-accent mb-2">
                        <p class="text-[10px] text-slate-500 mb-2">用於文案優化與圖片分析。若未輸入將嘗試使用系統預設。</p>
                        <button @click="showApiKey = false" class="w-full bg-brand-accent text-slate-900 text-xs font-bold py-1.5 rounded hover:bg-sky-400">確認</button>
                    </div>
                </div>

                <div class="hidden md:flex text-xs font-mono bg-slate-800 px-3 py-1 rounded text-brand-warning border border-yellow-900 items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-brand-warning animate-pulse"></span>
                    Gemini 2.5 Flash
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        
        <!-- Step Indicator -->
        <div class="flex justify-center mb-10">
            <div class="flex items-center space-x-4">
                <div :class="{'text-brand-success': step >= 1, 'text-slate-600': step < 1}" class="flex flex-col items-center">
                    <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold mb-1" :class="step >= 1 ? 'border-brand-success bg-brand-success/20' : 'border-slate-600'">1</div>
                    <span class="text-xs">參數設定</span>
                </div>
                <div class="w-16 h-0.5" :class="step >= 2 ? 'bg-brand-success' : 'bg-slate-700'"></div>
                <div :class="{'text-brand-success': step >= 2, 'text-slate-600': step < 2}" class="flex flex-col items-center">
                    <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold mb-1" :class="step >= 2 ? 'border-brand-success bg-brand-success/20' : 'border-slate-600'">2</div>
                    <span class="text-xs">選擇變體</span>
                </div>
                <div class="w-16 h-0.5" :class="step >= 3 ? 'bg-brand-success' : 'bg-slate-700'"></div>
                <div :class="{'text-brand-success': step >= 3, 'text-slate-600': step < 3}" class="flex flex-col items-center">
                    <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold mb-1" :class="step >= 3 ? 'border-brand-success bg-brand-success/20' : 'border-slate-600'">3</div>
                    <span class="text-xs">取得提示詞</span>
                </div>
            </div>
        </div>

        <!-- Step 1: Input Form -->
        <transition name="fade" mode="out-in">
            <section v-if="step === 1" key="step1" class="space-y-8">
                
                <!-- Text Inputs -->
                <div class="glass-panel p-6 rounded-xl relative">
                    <div class="flex justify-between items-center mb-4 border-l-4 border-brand-success pl-3">
                        <h2 class="text-lg font-bold text-white">1. 文案內容</h2>
                        
                        <!-- AI Optimization Button -->
                        <button @click="optimizeText" :disabled="isOptimizing || !form.mainTitle" 
                                class="text-xs bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-400 hover:to-purple-500 text-white font-bold py-1.5 px-4 rounded-full shadow-lg transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i v-if="isOptimizing" class="fas fa-spinner fa-spin"></i>
                            <i v-else class="fas fa-magic"></i>
                            {{ isOptimizing ? 'AI 思考中...' : 'AI 文案優化' }}
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">主標題 (必填)</label>
                            <input v-model="form.mainTitle" type="text" placeholder="例如：當沖實戰攻略" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-brand-success focus:outline-none placeholder-slate-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">副標題 (選填)</label>
                            <input v-model="form.subTitle" type="text" placeholder="例如：30天掌握獲利關鍵" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-brand-success focus:outline-none placeholder-slate-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-300 mb-1">重點文字/CTA (選填)</label>
                            <input v-model="form.cta" type="text" placeholder="例如：限時免費報名" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-brand-success focus:outline-none placeholder-slate-500">
                        </div>
                    </div>

                    <!-- AI Suggestions Panel -->
                    <transition name="fade">
                        <div v-if="suggestions" class="mt-6 bg-indigo-900/30 border border-indigo-500/50 rounded-lg p-4 animate-fade-in-up">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-sm font-bold text-indigo-300 flex items-center gap-2">
                                    <i class="fas fa-robot"></i> AI 優化建議
                                    <span class="text-[10px] text-indigo-400 font-normal ml-2">點擊「採用」以套用文案</span>
                                </h3>
                                <button @click="suggestions = null" class="text-xs text-slate-400 hover:text-white transition-colors">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- Main Title Suggestion -->
                                <div class="bg-slate-800/80 p-3 rounded border border-slate-700/50 hover:border-indigo-500/30 transition-colors">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="text-[10px] text-slate-400 font-bold uppercase">主標題</span>
                                        <button @click="applySuggestion('mainTitle')" class="text-[10px] bg-indigo-600 hover:bg-indigo-500 text-white px-2 py-0.5 rounded transition-colors">
                                            採用 <i class="fas fa-check ml-1"></i>
                                        </button>
                                    </div>
                                    <p class="text-sm text-indigo-100 font-medium">{{ suggestions.mainTitle }}</p>
                                </div>
                                
                                <!-- Sub Title Suggestion -->
                                <div class="bg-slate-800/80 p-3 rounded border border-slate-700/50 hover:border-indigo-500/30 transition-colors">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="text-[10px] text-slate-400 font-bold uppercase">副標題</span>
                                        <button @click="applySuggestion('subTitle')" class="text-[10px] bg-indigo-600 hover:bg-indigo-500 text-white px-2 py-0.5 rounded transition-colors">
                                            採用 <i class="fas fa-check ml-1"></i>
                                        </button>
                                    </div>
                                    <p class="text-sm text-indigo-100 font-medium">{{ suggestions.subTitle || '(無建議)' }}</p>
                                </div>

                                <!-- CTA Suggestion -->
                                <div class="bg-slate-800/80 p-3 rounded border border-slate-700/50 hover:border-indigo-500/30 transition-colors">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="text-[10px] text-slate-400 font-bold uppercase">CTA</span>
                                        <button @click="applySuggestion('cta')" class="text-[10px] bg-indigo-600 hover:bg-indigo-500 text-white px-2 py-0.5 rounded transition-colors">
                                            採用 <i class="fas fa-check ml-1"></i>
                                        </button>
                                    </div>
                                    <p class="text-sm text-indigo-100 font-medium">{{ suggestions.cta || '(無建議)' }}</p>
                                </div>
                            </div>
                        </div>
                    </transition>
                </div>

                <!-- Color Selection -->
                <div class="glass-panel p-6 rounded-xl">
                    <h2 class="text-lg font-bold text-white mb-4 border-l-4 border-brand-success pl-3">2. 色系組合</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 md:grid-cols-5 gap-4">
                        <div v-for="color in colorSchemes" :key="color.id" 
                             @click="form.selectedColor = color"
                             :class="form.selectedColor.id === color.id ? 'ring-2 ring-brand-success scale-105' : 'opacity-70 hover:opacity-100'"
                             class="cursor-pointer bg-slate-800 rounded-lg p-3 transition-all duration-200 border border-slate-700">
                            <div class="flex h-12 rounded-md overflow-hidden mb-2">
                                <div class="w-1/2 h-full" :style="{ backgroundColor: color.main }"></div>
                                <div class="w-1/2 h-full" :style="{ backgroundColor: color.sub }"></div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm font-bold text-white">{{ color.name }}</div>
                                <div class="text-[10px] text-slate-400">{{ color.desc }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Style Selection -->
                <div class="glass-panel p-6 rounded-xl">
                    <h2 class="text-lg font-bold text-white mb-4 border-l-4 border-brand-success pl-3">3. 設計風格</h2>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        
                        <!-- Upload Option -->
                        <div class="ai-border bg-slate-800 hover:bg-slate-750 cursor-pointer rounded-lg p-4 flex flex-col items-center justify-center gap-3 transition-all duration-200 border border-dashed border-slate-600 relative overflow-hidden group h-32"
                             @click="triggerFileUpload">
                            
                            <input type="file" ref="fileInput" @change="handleImageUpload" accept="image/*" class="hidden">
                            
                            <div v-if="isAnalyzing" class="flex flex-col items-center">
                                <i class="fas fa-spinner fa-spin text-2xl text-purple-400 mb-2"></i>
                                <span class="text-xs text-purple-300">AI 分析中...</span>
                            </div>
                            <div v-else-if="customStyle" class="flex flex-col items-center w-full h-full justify-center">
                                <img :src="customStyle.preview" class="absolute inset-0 w-full h-full object-cover opacity-40 group-hover:opacity-60 transition-opacity">
                                <i class="fas fa-check-circle text-2xl text-green-400 z-10 drop-shadow-lg"></i>
                                <span class="text-xs font-bold text-white z-10 mt-1 drop-shadow-md">已提取風格</span>
                            </div>
                            <div v-else class="flex flex-col items-center text-center">
                                <i class="fas fa-cloud-upload-alt text-3xl text-slate-400 group-hover:text-purple-400 transition-colors"></i>
                                <span class="text-sm font-medium text-slate-300 mt-2 group-hover:text-white">上傳參考圖</span>
                                <span class="text-[10px] text-slate-500">AI 自動提取風格</span>
                            </div>
                            
                            <!-- Overlay selection for custom style -->
                             <div v-if="customStyle && form.selectedStyle.id === 'custom'" 
                                  class="absolute inset-0 border-2 border-brand-success bg-brand-success/10 z-20 pointer-events-none"></div>
                        </div>

                        <!-- Existing Styles -->
                        <div v-for="style in styles" :key="style.id"
                             @click="selectStyle(style)"
                             :class="form.selectedStyle.id === style.id ? 'ring-2 ring-brand-success bg-slate-700' : 'bg-slate-800 hover:bg-slate-700'"
                             class="cursor-pointer rounded-lg p-4 flex flex-col items-center justify-center gap-3 transition-all duration-200 border border-slate-700 h-32 relative">
                            <i :class="style.icon" class="text-3xl" :style="{ color: form.selectedStyle.id === style.id ? '#10b981' : '#94a3b8' }"></i>
                            <span class="text-sm font-medium text-center">{{ style.name }}</span>
                        </div>
                    </div>
                </div>

                <!-- Action -->
                <div class="flex justify-end pt-4">
                    <button @click="generatePromptVariations" :disabled="!isFormValid" 
                            class="bg-brand-success hover:bg-emerald-400 text-slate-900 font-bold py-3 px-8 rounded-lg shadow-lg shadow-emerald-900/50 transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span>生成 Prompt 變體</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </section>
        </transition>

        <!-- Step 2: Prompt Selection -->
        <transition name="fade" mode="out-in">
            <section v-if="step === 2" key="step2" class="space-y-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold text-white">選擇一組您喜歡的 Prompt 邏輯</h2>
                        <p class="text-sm text-slate-400">系統生成了三種不同的構圖描述，請選擇一個作為基底。</p>
                    </div>
                    <button @click="step = 1" class="text-slate-400 hover:text-white text-sm">
                        <i class="fas fa-arrow-left mr-1"></i> 返回修改
                    </button>
                </div>

                <div class="grid grid-cols-1 gap-6">
                    <div v-for="(variation, index) in promptVariations" :key="index" class="glass-panel p-6 rounded-xl border border-slate-700 hover:border-slate-500 transition-colors">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-bold text-brand-success flex items-center gap-2">
                                    <span class="bg-brand-success/20 px-2 py-0.5 rounded text-sm">#{{ index + 1 }}</span>
                                    {{ variation.title }}
                                </h3>
                                <p class="text-xs text-slate-400 mt-1">{{ variation.description }}</p>
                            </div>
                        </div>
                        <div class="relative group">
                            <textarea readonly class="w-full h-32 bg-slate-900/50 text-slate-300 text-sm font-mono p-4 rounded-lg border border-slate-800 focus:outline-none resize-none mb-4">{{ variation.text }}</textarea>
                            <button @click="selectVariation(index)" 
                                    class="w-full py-3 bg-slate-700 hover:bg-brand-success hover:text-slate-900 text-white font-bold rounded-lg transition-colors border border-slate-600">
                                選擇此風格並生成尺寸變體
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </transition>

        <!-- Step 3: Final Prompts -->
        <transition name="fade" mode="out-in">
            <section v-if="step === 3" key="step3" class="space-y-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold text-white">多尺寸 Prompt 已生成</h2>
                        <p class="text-sm text-slate-400">已根據您選擇的風格，生成適用於不同尺寸的 Prompt。您可以直接複製到 AI 繪圖工具中使用。</p>
                    </div>
                    <button @click="step = 2" class="text-slate-400 hover:text-white text-sm">
                        <i class="fas fa-arrow-left mr-1"></i> 上一步
                    </button>
                </div>

                <!-- Results List -->
                <div class="space-y-6">
                    <div v-for="size in targetSizes" :key="size.label" class="bg-slate-800/50 border border-slate-700 rounded-xl p-0 overflow-hidden">
                        <!-- Header -->
                        <div class="bg-slate-900/80 px-4 py-3 border-b border-slate-700 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <span class="text-brand-success font-bold font-mono">{{ size.width }}x{{ size.height }}</span>
                                <span class="text-xs text-slate-400 bg-slate-800 px-2 py-0.5 rounded border border-slate-700">{{ size.usage }}</span>
                            </div>
                            <button @click="copyToClipboard(finalPrompts[size.label])" 
                                    class="text-xs bg-brand-success hover:bg-emerald-400 text-slate-900 font-bold px-3 py-1.5 rounded transition-colors flex items-center gap-1">
                                <i class="fas fa-copy"></i> 複製 Prompt
                            </button>
                        </div>
                        
                        <!-- Content -->
                        <div class="p-4 relative">
                            <textarea readonly 
                                class="w-full h-32 bg-transparent text-slate-300 text-xs font-mono p-2 focus:outline-none resize-none leading-relaxed"
                                :value="finalPrompts[size.label]"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Toast Notification -->
                <div v-if="showToast" class="fixed bottom-8 right-8 bg-brand-success text-slate-900 px-6 py-3 rounded-lg shadow-lg font-bold animate-bounce flex items-center gap-2">
                    <i class="fas fa-check-circle"></i>
                    {{ toastMessage }}
                </div>
            </section>
        </transition>

    </main>

    <!-- Footer -->
    <footer class="border-t border-slate-800 bg-slate-900 py-6 mt-8">
        <div class="max-w-7xl mx-auto px-4 text-center text-xs text-slate-600">
            &copy; 2025 StockGen AI Prompt Generator. Enhanced with Gemini 2.5 Flash.
        </div>
    </footer>

</div>

<script>
const { createApp, ref, reactive, computed } = Vue;

createApp({
    setup() {
        const step = ref(1);
        const apiKey = ref('');
        const showApiKey = ref(false);
        const showToast = ref(false);
        const toastMessage = ref('已複製到剪貼簿！');
        
        // AI State
        const isOptimizing = ref(false);
        const isAnalyzing = ref(false);
        const suggestions = ref(null);
        const customStyle = ref(null); // { id: 'custom', name: '自訂', icon: '...', prompt: '...', preview: 'base64' }
        const fileInput = ref(null);

        const promptVariations = ref([]);
        const finalPrompts = reactive({});

        // --- Data Definitions ---

        const colorSchemes = [
            { id: 1, name: '牛市紅金', desc: '熱情、獲利', main: '#E63946', sub: '#FFD700' },
            { id: 2, name: '穩健深藍', desc: '專業、信賴', main: '#0A2463', sub: '#3E92CC' },
            { id: 3, name: '財富翠綠', desc: '成長、能源', main: '#2A9D8F', sub: '#E9C46A' },
            { id: 4, name: '智慧黑紫', desc: '量化、高端', main: '#1B1B1E', sub: '#7209B7' },
            { id: 5, name: '明亮活力', desc: '親切、入門', main: '#F4A261', sub: '#FFFFFF' }
        ];

        const styles = [
            { id: 'neo_minimalism', name: '新極簡主義', icon: 'fas fa-feather', prompt: 'Neo-Minimalism style, lots of negative space, clean beige or light gray background, sense of stability and peace, ultra clean layout.' },
            { id: 'glassmorphism', name: '科技玻璃感', icon: 'fas fa-layer-group', prompt: 'Glassmorphism style, frosted glass background effects, semi-transparent floating cards, high-tech analysis vibe, transparency.' },
            { id: 'bold_color', name: '大膽撞色', icon: 'fas fa-palette', prompt: 'Bold Color Revival style, high saturation contrast, pop art influence, explosive market growth feeling, sharp edges.' },
            { id: 'cyberpunk', name: '賽博龐克', icon: 'fas fa-microchip', prompt: 'Cyberpunk style, neon lights, dark background, flowing data streams, quantitative trading vibe, glowing grids.' },
            { id: '3d_fluid', name: '3D 抽象流體', icon: 'fas fa-water', prompt: '3D Fluid Abstract style, metallic or liquid flowing textures, visualizing money flow and market trends, smooth gradients.' },
            { id: 'isometric', name: '等距 3D', icon: 'fas fa-cubes', prompt: 'Isometric 3D style, game-like 3D financial charts, gold coins, mobile phone models, cute but professional 3D render.' },
            { id: 'retro_future', name: '復古未來', icon: 'fas fa-backward', prompt: 'Retro Futurism style, 80s synthwave aesthetic, grid background, vintage computer fonts, classic technical analysis charts.' },
            { id: 'knolling', name: '散布式工具', icon: 'fas fa-tools', prompt: 'Knolling style, flat lay photography, neatly arranged investment tools, laptop, candlestick charts, pen, coffee, organized.' },
            { id: 'professional', name: '專業信賴', icon: 'fas fa-user-tie', prompt: 'Professional Trust style, deep blue tones, blurred real office background, cinematic lighting, trustworthy atmosphere.' },
            { id: 'data_viz', name: '數據藝術', icon: 'fas fa-chart-line', prompt: 'Data Visualization Art style, candlestick charts transformed into artistic lines, clean background, fundamental analysis focus.' }
        ];

        const targetSizes = [
            { width: 970, height: 250, label: 'top_banner', usage: '頂部橫幅', modifier: 'Panoramic view, Wide shot, Horizontal composition, negative space on sides for text placement, elements spread out horizontally.' },
            { width: 440, height: 50, label: 'small_banner', usage: '小型橫幅', modifier: 'Extreme wide strip, minimalist elements, very simple background pattern to allow text readability, avoid clutter.' },
            { width: 300, height: 100, label: 'sidebar', usage: '側邊欄', modifier: 'Compact composition, close-up on key visual element, simplified visual hierarchy.' },
            { width: 970, height: 500, label: 'hero', usage: '大型看板', modifier: 'Hero shot, detailed 3D composition, complex layering, vertical depth, rich details.' }
        ];

        const form = reactive({
            mainTitle: '',
            subTitle: '',
            cta: '',
            selectedColor: colorSchemes[1],
            selectedStyle: styles[1]
        });

        // --- Logic ---

        const isFormValid = computed(() => {
            return form.mainTitle.length > 0;
        });

        const showNotification = (msg) => {
            toastMessage.value = msg;
            showToast.value = true;
            setTimeout(() => showToast.value = false, 3000);
        };

        const copyToClipboard = (text) => {
            if (!navigator.clipboard) {
                console.error('Clipboard API 不支援');
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                showNotification('已複製到剪貼簿！');
            }).catch(err => {
                console.error('複製到剪貼簿失敗:', err);
            });
        };

        const selectStyle = (style) => {
            form.selectedStyle = style;
        };

        const triggerFileUpload = () => {
            if (customStyle.value) {
                // If already uploaded, just select it
                form.selectedStyle = customStyle.value;
            } else {
                // Otherwise open dialog
                fileInput.value.click();
            }
        };

        // --- AI Implementation ---

        const getGeminiKey = () => {
            // Priority: User Input > Env Variable (simulated empty here)
            return apiKey.value || ''; 
        };

        const optimizeText = async () => {
            if (!form.mainTitle) return;
            const key = getGeminiKey();
            if (!key) {
                showNotification("請先在右上角設定 API Key 才能使用 AI 功能");
                showApiKey.value = true;
                return;
            }

            isOptimizing.value = true;
            try {
                const prompt = `
                    You are a professional marketing copywriter for stock trading courses.
                    Please optimize the following text to be more catchy, high-converting, and professional.
                    Input Main Title: "${form.mainTitle}"
                    Input Sub Title: "${form.subTitle}"
                    Input CTA: "${form.cta}"
                    
                    Respond ONLY with a JSON object in this format (no markdown code blocks):
                    {
                        "mainTitle": "Optimized Main Title (Traditional Chinese)",
                        "subTitle": "Optimized Sub Title (Traditional Chinese)",
                        "cta": "Optimized CTA (Traditional Chinese)"
                    }
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                let text = data.candidates[0].content.parts[0].text;
                // Clean markdown code blocks if present
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const result = JSON.parse(text);
                
                // Store suggestions instead of replacing immediately
                suggestions.value = result;
                showNotification("AI 建議已生成，請查看下方建議區");

            } catch (error) {
                console.error(error);
                showNotification("優化失敗，請檢查 API Key 或網路");
            } finally {
                isOptimizing.value = false;
            }
        };

        const applySuggestion = (field) => {
            if (suggestions.value && suggestions.value[field]) {
                form[field] = suggestions.value[field];
                showNotification(`已套用 ${field === 'mainTitle' ? '主標題' : field === 'subTitle' ? '副標題' : 'CTA'}`);
            }
        };

        const handleImageUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const key = getGeminiKey();
            if (!key) {
                showNotification("請先在右上角設定 API Key 才能使用圖片分析");
                showApiKey.value = true;
                return;
            }

            isAnalyzing.value = true;
            
            // Convert to Base64
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Data = e.target.result.split(',')[1];
                const mimeType = file.type;
                const previewUrl = e.target.result;

                try {
                    const prompt = `
                        Analyze this image. Describe its artistic style, lighting, color palette, composition, and mood in detail.
                        Write a high-quality image generation prompt based on this image.
                        Focus on the visual style (e.g., Cyberpunk, Minimalist, Watercolor, etc.) and technical details (e.g., 8k, soft lighting).
                        Do not describe specific text in the image, focus on the DESIGN STYLE.
                        Output concise prompt text in English.
                    `;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    { inlineData: { mimeType: mimeType, data: base64Data } }
                                ]
                            }]
                        })
                    });

                    if (!response.ok) throw new Error('API Error');

                    const data = await response.json();
                    const styleDescription = data.candidates[0].content.parts[0].text;

                    // Create custom style object
                    customStyle.value = {
                        id: 'custom',
                        name: '自訂圖片風格',
                        icon: 'fas fa-image',
                        prompt: styleDescription,
                        preview: previewUrl
                    };

                    // Select it
                    form.selectedStyle = customStyle.value;
                    showNotification("風格分析完成！已套用。");

                } catch (error) {
                    console.error(error);
                    showNotification("圖片分析失敗，請重試");
                } finally {
                    isAnalyzing.value = false;
                }
            };
            reader.readAsDataURL(file);
        };

        // --- Prompt Generation Logic (Updated with Descriptions) ---

        const generatePromptVariations = () => {
            if (!isFormValid.value) return;
            
            const stylePrompt = form.selectedStyle.prompt;
            const colorInstruction = `Color Palette: Use Main Color ${form.selectedColor.main} and Accent Color ${form.selectedColor.sub}. IMPORTANT: Use these hex colors for the visual theme and elements, but do NOT render the hex code text on the image.`;
            const contentInstruction = `Text to render (Chinese Traditional): "${form.mainTitle}". ${form.subTitle ? `Secondary text: "${form.subTitle}".` : ''} ${form.cta ? `Call to action: "${form.cta}".` : ''}`;
            const qualityInstruction = "High quality, 8k resolution, commercial photography or 3D render, clean typography.";

            const v1 = `[Variation: Balanced]
${stylePrompt}
${colorInstruction}
${contentInstruction}
Composition: Balanced center composition, bold typography, professional lighting.
${qualityInstruction}`;

            const v2 = `[Variation: Dynamic]
${stylePrompt}
${colorInstruction}
${contentInstruction}
Composition: Dynamic angle, depth of field, motion blur on background elements to suggest market movement.
${qualityInstruction}`;

            const v3 = `[Variation: Minimalist]
${stylePrompt}
${colorInstruction}
${contentInstruction}
Composition: Maximum negative space, clean lines, focus entirely on the text and one key visual element.
${qualityInstruction}`;

            // Updated to array of objects
            promptVariations.value = [
                { title: "平衡構圖 (Balanced)", description: "視覺重心居中，字體粗獷，展現專業穩重感。", text: v1 },
                { title: "動態視角 (Dynamic)", description: "運用景深與動態模糊，營造市場快速變化的張力。", text: v2 },
                { title: "極簡留白 (Minimalist)", description: "最大化負空間，去除雜訊，聚焦於核心訊息。", text: v3 }
            ];
            step.value = 2;
        };

        const selectVariation = (index) => {
            const base = promptVariations.value[index].text; // Access text property
            targetSizes.forEach(size => {
                finalPrompts[size.label] = `${base}
                
-- SIZE ADJUSTMENT --
Target Dimension: ${size.width}x${size.height}
Layout Instruction: ${size.modifier}
Ensure main text "${form.mainTitle}" is legible and fits within the ${size.width}px width.`;
            });
            step.value = 3;
        };

        return {
            step,
            apiKey,
            showApiKey,
            showToast,
            toastMessage,
            isOptimizing,
            isAnalyzing,
            suggestions,
            applySuggestion,
            customStyle,
            fileInput,
            form,
            isFormValid,
            styles,
            colorSchemes,
            targetSizes,
            promptVariations,
            finalPrompts,
            optimizeText,
            handleImageUpload,
            triggerFileUpload,
            selectStyle,
            generatePromptVariations,
            selectVariation,
            copyToClipboard
        };
    }
}).mount('#app');
</script>

</body>
</html>
